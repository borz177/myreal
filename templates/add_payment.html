{% extends "base.html" %}

{% block title %}Добавить платеж{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/add-payment.css') }}">
{% endblock %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4">Добавить платеж</h2>

  {% if error %}
  <div class="alert alert-danger alert-dismissible fade show">
    {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
  </div>
  {% endif %}

  {% if not client_name %}
  <div class="mb-4">
    <label for="clientSearch" class="form-label">Поиск клиента:</label>
    <div class="input-group">
      <span class="input-group-text"><i class="bi bi-search"></i></span>
      <input type="text" id="clientSearch" class="form-control" placeholder="Начните вводить имя клиента..." autofocus>
    </div>
    <div id="searchResults" class="list-group mt-2 shadow-sm" style="display: none;"></div>
  </div>

  <hr class="my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Все клиенты:</h5>
    <span class="badge bg-primary rounded-pill">{{ all_clients|length }}</span>
  </div>

  {% if all_clients %}
  <div class="list-group" id="allClientsList">
    {% for name in all_clients %}
    <a href="{{ url_for('add_payment', client_name=name) }}"
       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
      {{ name }}
      <i class="bi bi-chevron-right"></i>
    </a>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info">
    <i class="bi bi-info-circle"></i> Список клиентов пуст.
  </div>
  {% endif %}

  {% else %}
  <div class="alert alert-primary d-flex justify-content-between align-items-center mb-4">
    <div>
      <i class="bi bi-person-fill"></i>
      <strong>Клиент:</strong> {{ client_name }}
    </div>
    <a href="{{ url_for('add_payment') }}" class="btn btn-sm btn-outline-secondary">
      <i class="bi bi-x-lg"></i> Сбросить
    </a>
  </div>

  <form method="POST" class="needs-validation" novalidate>
    <div class="mb-3">
      <label for="item_id" class="form-label">Товар:</label>
      <select name="item_id" class="form-select" required id="itemSelect">
        {% for item in items %}
        <option value="{{ item.id }}" data-price="{{ item.price }}" data-purchase="{{ item.purchase_price }}">
          {{ item.name }} — {{ item.price | rub }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label for="amount" class="form-label">Сумма платежа:</label>
      <div class="input-group">
        <input type="number" name="amount" step="0.01" class="form-control" required id="amountInput">
        <span class="input-group-text">₽</span>
      </div>
    </div>

    <div class="alert alert-success mb-3">
      <strong>Прибыль с платежа:</strong> <span id="paymentProfit">—</span>
    </div>

    <div class="mb-3">
      <label for="created_at" class="form-label">Дата платежа:</label>
      <input type="date" name="created_at" class="form-control" required value="{{ current_date }}">
    </div>

    {% if current_user.active_license and current_user.active_license.is_active %}
    <button type="submit" class="btn btn-success" {% if not items %}disabled{% endif %}>
      <i class="bi bi-check-circle"></i> Сохранить платеж
    </button>
    {% else %}
    <button type="button" class="btn btn-secondary" disabled>
      <i class="bi bi-lock"></i> Доступ ограничен
    </button>
    {% endif %}
  </form>

  {% if payments %}
  <hr class="my-4">
  <h4 class="mb-3"><i class="bi bi-clock-history"></i> История платежей</h4>
  <div class="list-group shadow-sm">
    {% for payment in payments %}
    <div class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <strong>{{ payment.item.name }}</strong>
        <div class="text-muted small">
          {{ payment.created_at.strftime('%d.%m.%Y') if payment.created_at else 'Дата не указана' }}
        </div>
      </div>
      <div class="d-flex align-items-center">
        <span class="badge bg-success rounded-pill me-2">{{ payment.amount | rub }}</span>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info mt-3">
    <i class="bi bi-info-circle"></i> Платежи ещё не добавлены.
  </div>
  {% endif %}
  {% endif %}
</div>

  <!-- Передаём данные -->
  <script id="items-data" type="application/json">
    {{ items | tojson }}
  </script>
  <script id="clients-data" type="application/json">
    {{ all_clients | tojson }}
  </script>

  <!-- Подключаем JS в конце body -->
  <script src="{{ url_for('static', filename='js/add-payment.js') }}"></script>

{% endblock %}