{% extends "base.html" %}
{% block content %}

{% if license_expiration %}
  <div class="alert alert-info">
    Ваша подписка активна до {{ license_expiration.strftime('%d.%m.%Y') }}.
  </div>
{% else %}
  <div class="alert alert-warning">
    У вас нет активной подписки.
    <div class="mt-2">
      <a href="https://wa.me/9657777027" target="_blank" class="btn btn-success">
         Написать в WhatsApp
      </a>
    </div>
  </div>
{% endif %}

<div class="container mt-4">
  <div class="card shadow-sm">
    <div class="card-header bg-white">
      <h2 class="h5 mb-0">Оформить товар</h2>
    </div>
    <div class="card-body form-card">
      <form id="itemForm" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        <!-- Инвестор -->
        <div class="form-field">
          <label for="investor" class="form-label">Инвестор</label>
          <div class="input-group">
            <select name="investor_id" class="form-select">
              <option value="">Без инвестора</option>
              {% for inv in investors %}
                {% if inv.id is not none %}
                  <option value="{{ inv.id }}"
                    {% if (request.form.get('investor_id')|int == inv.id) or (selected_id|int == inv.id) %}selected{% endif %}>
                    {{ inv.name }}
                  </option>
                {% endif %}
              {% endfor %}
            </select>
            <a class="btn btn-outline-primary" href="{{ url_for('add_investor') }}" title="Добавить инвестора">+</a>
          </div>
        </div>

        <!-- Дата оформления -->
        <div class="form-field">
          <label for="created_at" class="form-label">Дата оформления</label>
          <input type="date" class="form-control" name="created_at" id="created_at"
                 value="{{ current_date }}" required>
          <div class="invalid-feedback">Заполните поле</div>
        </div>

        <!-- Дата первого платежа -->
        <div class="form-field">
          <label for="first_payment_date" class="form-label">Дата первого платежа</label>
          <input type="date" class="form-control" id="first_payment_date" name="first_payment_date" required>
          <div class="invalid-feedback">Укажите дату первого платежа</div>
        </div>

        <!-- ФИО клиента -->
        <div class="form-field position-relative">
          <label for="client_name" class="form-label">ФИО клиента</label>
          <input type="text" class="form-control" id="client_name" name="client_name" required autocomplete="off">
          <div class="invalid-feedback">Заполните поле</div>
          <div id="autocomplete-list" class="list-group position-absolute w-100"></div>
        </div>

        <!-- Телефон клиента -->
        <div class="form-field">
          <label for="client_phone" class="form-label">Телефон клиента</label>
          <input type="tel" class="form-control" id="client_phone" name="client_phone"
                 value="{{ item.phone_number if item else '' }}"
                 placeholder="+7 (___) ___-__-__"
                 pattern="^\+7 \(\d{3}\) \d{3}-\d{2}-\d{2}$"
                 required>
          <div class="invalid-feedback">Введите корректный номер</div>
        </div>

        <!-- Адрес проживания клиента -->
        <div class="form-field">
          <label for="client_address" class="form-label">Адрес проживания</label>
          <input type="text" class="form-control" id="client_address" name="client_address" required>
          <div class="invalid-feedback">Заполните поле</div>
        </div>

        <!-- Название товара -->
        <div class="form-field">
          <label for="name" class="form-label">Название товара</label>
          <input type="text" class="form-control" id="name" name="name" required>
          <div class="invalid-feedback">Заполните поле</div>
        </div>

        <!-- Цена закупа -->
        <div class="form-field">
          <label for="purchase_price" class="form-label">Цена закупа</label>
          <div class="input-group has-validation">
            <input type="number" step="0.01" class="form-control" name="purchase_price"
                   id="purchase_price" required value="{{ item.purchase_price if item else '' }}">
            <span class="input-group-text">₽</span>
            <div class="invalid-feedback">Заполните поле</div>
          </div>
        </div>

        <!-- Наценка -->
        <div class="form-field">
          <label for="profit_margin" class="form-label">Наценка (%)</label>
          <div class="d-flex align-items-center gap-3">
            <input type="range" class="form-range" id="profit_margin" min="1" max="100" value="25" style="flex: 1;">
            <span id="margin_display">10%</span>
          </div>
        </div>

        <!-- Цена в рассрочку -->
        <div class="form-field">
          <label for="installment_price" class="form-label">Цена в рассрочку</label>
          <div class="input-group has-validation">
            <input type="number" step="0.01" class="form-control" name="price"
                   id="installment_price" required value="{{ item.price if item else '' }}">
            <span class="input-group-text">₽</span>
            <div class="invalid-feedback">Заполните поле</div>
          </div>
        </div>

        <!-- Первоначальный взнос -->
        <div class="form-field">
          <label for="down_payment" class="form-label">Первоначальный взнос</label>
          <div class="input-group">
            <input type="number" step="0.01" min="0" class="form-control" id="down_payment" name="down_payment">
            <span class="input-group-text">₽</span>
          </div>
        </div>

        <!-- Ежемесячный платёж -->
        <div class="form-field">
          <label for="monthly_payment" class="form-label">Ежемесячный платёж</label>
          <input type="text" class="form-control" id="monthly_payment" readonly>
        </div>

        <!-- Срок рассрочки -->
        <div class="form-field">
          <label for="installments" class="form-label">Срок рассрочки:
            <span id="installmentsValue">12 месяцев</span>
          </label>
          <input type="range" class="form-range" id="installments" name="installments" min="1" max="24" value="12" required>
          <div class="invalid-feedback">Выберите срок</div>
        </div>

        <!-- Поручитель -->
        <div class="form-field">
          <label for="guarantor_name" class="form-label">ФИО поручителя (необязательно)</label>
          <input type="text" class="form-control optional-quiet" id="guarantor_name" name="guarantor_name">
        </div>

        <!-- Телефон поручителя -->
        <div class="form-field">
          <label for="guarantor_phone" class="form-label">Телефон поручителя (необязательно)</label>
          <input type="tel" class="form-control optional-quiet" id="guarantor_phone" name="guarantor_phone"
                 value="{{ item.guarantor_phone if item and item.guarantor_phone else '' }}"
                 placeholder="+7 (___) ___-__-__">
        </div>

        <!-- Фото товара -->
        <div class="form-field">
          <label for="photo" class="form-label">Фото товара</label>
          <input type="file" class="form-control" id="photo" name="photo" accept="image/*">
        </div>

        <!-- Кнопка отправки -->
        <div class="mt-4">
          {% if current_user.active_license and current_user.active_license.is_active %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#confirmModal">
              Оформить
            </button>
          {% else %}
            <button type="button" class="btn btn-secondary" disabled>Доступ ограничен</button>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  <!-- Оформленные сегодня -->
  <h3 class="mt-5">Оформленные сегодня</h3>
  {% if items %}
    <table class="table table-striped table-hover mt-3">
      <thead>
        <tr>
          <th>ФИО клиента</th>
          <th>Название</th>
          <th>Цена</th>
          <th>Срок</th>
          <th>Фото</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
          <tr onclick="window.location='{{ url_for('edit_item', item_id=item.id) }}'" style="cursor: pointer;">
            <td>{{ item.client_name }}</td>
            <td>{{ item.name }}</td>
            <td>{{ item.purchase_price }} ₽</td>
            <td>{{ item.installments }} мес.</td>
            <td>
              {% if item.photo_url %}
                {% set photo_path = 'uploads/' ~ item.photo_url %}
                <a href="{{ url_for('static', filename=photo_path) }}" target="_blank">
                  <img src="{{ url_for('static', filename=photo_path) }}" alt="Фото" style="height: 60px; object-fit: cover;">
                </a>
              {% else %}
                &mdash;
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="text-muted">За сегодня ничего не оформлено.</p>
  {% endif %}
</div>

<!-- Модальное окно подтверждения -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">Подтверждение</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
      </div>
      <div class="modal-body">Вы уверены, что хотите оформить этот товар?</div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button type="button" class="btn btn-primary" id="confirmSubmit">Подтвердить</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}