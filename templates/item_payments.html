{% extends "base.html" %}
{% block title %}Платежи по товару{% endblock %}

{% block content %}
<!-- Передаём данные о товаре в JS -->
<script id="item-data" type="application/json">
  {{ {
    'price': item.price or 0,
    'purchase_price': item.purchase_price or 0
  } | tojson }}
</script>

<div class="client-product-card card border-0 shadow-sm mb-4">
  <!-- Индикатор загрузки -->
  <div id="loadingIndicator">
    <img src="{{ url_for('static', filename='icons/loading.svg') }}" alt="Загрузка...">
    <p>Загрузка...</p>
  </div>

  <!-- Блок клиента -->
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>{{ item.client_name }}</h5>
  </div>
  <div class="card-body">
    <!-- Блок товара -->
    <div class="product-section">
      <h6 class="d-flex align-items-center mb-1">
        <i class="fas fa-box-open text-primary me-2"></i>
        <strong>Товар:</strong>
        <span class="ms-2">{{ item.name }}</span>
      </h6>
    </div>

    <!-- Финансовая информация -->
    <ul class="list-group list-group-flush">
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="far fa-calendar text-muted me-2"></i><strong>Дата оформления:</strong></span>
        <span class="value-badge">{{ item.created_at.strftime('%d.%m.%Y') }}</span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-tag text-muted me-2"></i><strong>Цена закупа:</strong></span>
        <span class="value-badge">{{ item.purchase_price | rub }}</span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-credit-card text-muted me-2"></i><strong>Цена в рассрочку:</strong></span>
        <span class="value-badge">{{ item.price | rub }}</span>
      </li>
      {% if item.down_payment %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-hand-holding-usd text-muted me-2"></i><strong>Взнос:</strong></span>
        <span class="value-badge">{{ item.down_payment | rub }}</span>
      </li>
      {% endif %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-calendar-day text-muted me-2"></i><strong>Ежемесячный платёж:</strong></span>
        <span class="value-badge">
          {{
            ((item.price - (item.down_payment or 0)) / item.installments) | round(0, 'ceil') | int | rub
          }}
        </span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="far fa-calendar-alt text-muted me-2"></i><strong>Срок рассрочки:</strong></span>
        <span class="value-badge">{{ item.installments }} мес.</span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-check-circle text-muted me-2"></i><strong>Оплачено:</strong></span>
        <span class="value-badge">{{ total_paid | rub }}</span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-calendar-week text-muted me-2"></i><strong>Остаток:</strong></span>
        <span class="value-badge">{{ (remaining or 0) | rub }}</span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-calendar-week text-muted me-2 mt-4"></i><strong>Прибыль в месяц:</strong></span>
        <span class="value-badge">
          {% if (item.installments or 0) > 0 %}
            {{ (((item.price or 0) - (item.purchase_price or 0)) / item.installments) | round(2) | rub }}
          {% else %}
            —
          {% endif %}
        </span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-chart-line text-muted me-2"></i><strong>Общая прибыль:</strong></span>
        <span class="value-badge">{{ ((item.price or 0) - (item.purchase_price or 0)) | rub }}</span>
      </li>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span><i class="fas fa-info-circle text-muted me-2"></i><strong>Статус:</strong></span>
        <span class="status-badge" data-status="{{ item.status }}">{{ item.status }}</span>
      </li>
    </ul>
  </div>
</div>

<h4>История платежей</h4>
<div class="mb-3">
  {% if item.access_token %}
    <a href="{{ url_for('export_pdf_by_token', token=item.access_token) }}" class="btn btn-primary">
      <i class="bi bi-file-earmark-pdf"></i> Скачать PDF
    </a>
  {% else %}
    <span class="text-muted small">Нет доступа к PDF</span>
  {% endif %}

  {% if item.client_phone %}
    <a href="{{ url_for('whatsapp_link', item_id=item.id) }}" class="btn btn-success ms-2">
      <i class="bi bi-whatsapp"></i> Отправить в WhatsApp
    </a>
  {% endif %}
</div>

<table class="table table-bordered mt-2">
  <thead class="table-light">
    <tr>
      <th>#</th>
      <th>Дата</th>
      <th>Сумма</th>
      <th>Статус</th>
      <th>Действие</th>
    </tr>
  </thead>
  <tbody>
    {% if payments %}
      {% for payment in payments %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ payment.created_at.strftime('%d.%m.%Y') }}</td>
          <td>{{ payment.amount }} ₽</td>
          <td>
            {% if total_paid >= (item.price or 0) %}
              <span class="badge bg-success">Оплачено</span>
            {% else %}
              <span class="badge bg-warning text-dark">Частично</span>
            {% endif %}
          </td>
          <td onclick="event.stopPropagation()">
            <div class="d-flex gap-2">
              <button type="button"
                      class="btn btn-sm btn-outline-danger delete-payment-btn"
                      data-bs-toggle="modal"
                      data-bs-target="#deletePaymentModal{{ payment.id }}">
                Удалить
              </button>
            </div>
          </td>
        </tr>

        <!-- Модальное окно удаления платежа -->
        <div class="modal fade" id="deletePaymentModal{{ payment.id }}" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <form method="POST">
                <input type="hidden" name="delete_payment_id" value="{{ payment.id }}">
                <div class="modal-header">
                  <h5 class="modal-title">Подтверждение удаления</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                  Вы уверены, что хотите удалить этот платёж?
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                  <button type="submit" class="btn btn-danger">Удалить</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <tr>
        <td colspan="5" class="text-center text-muted">Платежей пока нет.</td>
      </tr>
    {% endif %}
  </tbody>
</table>

<a href="{{ url_for('client_detail', client_name=item.client_name) }}" class="btn btn-outline-secondary mt-3">
  ← Назад к клиенту
</a>
{% endblock %}