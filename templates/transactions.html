{% extends "base.html" %}
{% block title %}Журнал транзакций{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Заголовок -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">
        <i class="bi bi-journal-text me-2"></i>Журнал транзакций
      </h2>
      <p class="text-muted mb-0">История всех операций: платежи и транзакции</p>
    </div>
    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#filterModal">
      <i class="bi bi-funnel"></i> Фильтры
    </button>
  </div>

  <!-- Диаграмма -->
<div class="row mb-5">
  <div class="col-lg-6 mx-auto">
    <div class="card shadow-sm border-0 rounded-4">
      <div class="card-body p-4 d-flex justify-content-center">
        <h5 class="card-title mb-4">
          <i class="bi bi-pie-chart-fill me-2"></i>Финансовый обзор
        </h5>

        <div class="chart-container" style="width: 200px; height: 200px;">
          <canvas id="transactionsChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
  <!-- Таблица -->
  <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="ps-4">Дата</th>
            <th>Тип</th>
            <th>Счёт / Клиент</th>
            <th>Сумма</th>
            <th class="pe-4">Описание</th>
          </tr>
        </thead>
        <tbody>
          {% for t in transactions %}
          <tr class="
            {% if t.__class__.__name__ == 'Transaction' %}
              {% if t.type == 'income' %}income-row{% else %}expense-row{% endif %}
            {% elif t.__class__.__name__ == 'Payment' %}
              payment-row
            {% endif %}
          ">
            <td class="ps-4">
              <div class="fw-500">{{ t.created_at.strftime('%d.%m.%Y') }}</div>
              <div class="text-muted small">{{ t.created_at.strftime('%H:%M') }}</div>
            </td>
            <td>
              <span class="badge
                {% if t.__class__.__name__ == 'Transaction' %}
                  {% if t.type == 'income' %}
                     bg-info bg-opacity-10 text-info
                  {% else %}
                    bg-danger bg-opacity-10 text-danger
                  {% endif %}
                {% elif t.__class__.__name__ == 'Payment' %}
                  bg-success bg-opacity-10 text-success
                {% endif %}
                rounded-pill d-inline-flex align-items-center">
                <i class="bi
                  {% if t.__class__.__name__ == 'Transaction' %}
                    {% if t.type == 'income' %}bi-arrow-down-circle
                    {% else %}bi-arrow-up-circle
                    {% endif %}
                  {% elif t.__class__.__name__ == 'Payment' %}
                    bi-credit-card
                  {% endif %}
                  me-1">
                </i>
                {{
                  'Приход' if t.__class__.__name__ == 'Transaction' and t.type == 'income' else
                  'Расход' if t.__class__.__name__ == 'Transaction' and t.type == 'expense' else
                  'Платёж'
                }}
              </span>
            </td>
            <td>
  <div class="d-flex align-items-center">
    <!-- Иконка: кошелёк для транзакций, человек для платежей -->
    <div class="flex-shrink-0 bg-light rounded-3 p-2 me-2">
      <i class="bi
        {% if t.__class__.__name__ == 'Transaction' %}
          bi-wallet2 text-primary
        {% elif t.__class__.__name__ == 'Payment' %}
          bi-person text-success  <!-- Иконка клиента -->
        {% endif %}">
      </i>
    </div>
    <div>
      <!-- Основная строка: счёт или имя клиента -->
      <div class="fw-500">
        {% if t.__class__.__name__ == 'Transaction' %}
          {{ t.balance.name or 'Основной счёт' }}
        {% elif t.__class__.__name__ == 'Payment' %}
          {{ t.item.client_name or 'Аноним' }}  <!-- Только клиент, без товара -->
        {% endif %}
      </div>


    </div>
  </div>
</td>
            <td class="
              {% if t.__class__.__name__ == 'Transaction' %}
                {% if t.type == 'income' %}text-info{% else %}text-danger{% endif %}
              {% elif t.__class__.__name__ == 'Payment' %}
                text-success
              {% endif %}
              fw-bold">
              {{
                '%+.2f'|format(t.amount) if (t.__class__.__name__ == 'Transaction' and t.type == 'income') or t.__class__.__name__ == 'Payment'
                else '%-.2f'|format(t.amount)
              }} ₽
            </td>
            <td class="pe-4">
              <div class="text-truncate" style="max-width: 200px;" title="
                {% if t.__class__.__name__ == 'Transaction' %}
                  {{ t.description or 'Без описания' }}
                {% elif t.__class__.__name__ == 'Payment' %}
                  Платёж №{{ t.item.id }}
                {% endif %}
              ">
                {% if t.__class__.__name__ == 'Transaction' %}
                  {{ t.description or '-' }}
                {% elif t.__class__.__name__ == 'Payment' %}
                  Платёж №{{ t.item.id }}
                {% endif %}
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if not transactions %}
  <div class="text-center py-5 my-5">
    <div class="mb-4">
      <i class="bi bi-journal-x text-muted" style="font-size: 3rem;"></i>
    </div>
    <h4 class="mb-2">Нет транзакций</h4>
    <p class="text-muted">Здесь будут отображаться все ваши финансовые операции</p>
  </div>
  {% endif %}
</div>

<!-- Модальное окно фильтров -->
<div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content rounded-4 shadow-sm">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-funnel me-2"></i>Фильтры</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="GET" action="{{ url_for('transactions') }}">
          <div class="mb-3">
            <label class="form-label">Тип операции</label>
            <select name="type" class="form-select">
              <option value="all" {% if filters.type == "all" or not filters.type %}selected{% endif %}>Все</option>
              <option value="payment" {% if filters.type == "payment" %}selected{% endif %}>Платежи клиентов</option>
              <option value="income" {% if filters.type == "income" %}selected{% endif %}>Приход</option>
              <option value="expense" {% if filters.type == "expense" %}selected{% endif %}>Расход</option>
            </select>
          </div>
          <div class="row g-2">
            <div class="col-6">
              <label class="form-label">С</label>
              <input type="date" name="start_date" class="form-control" value="{{ filters.start_date or '' }}">
            </div>
            <div class="col-6">
              <label class="form-label">По</label>
              <input type="date" name="end_date" class="form-control" value="{{ filters.end_date or '' }}">
            </div>
          </div>
          <div class="modal-footer mt-3 p-0">
            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="submit" class="btn btn-sm btn-primary">Применить</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Стили -->
<style>
  .income-row:hover { background-color: rgba(25, 135, 84, 0.03); }
  .expense-row:hover { background-color: rgba(220, 53, 69, 0.03); }
  .payment-row:hover { background-color: rgba(23, 162, 184, 0.03); }

  tbody tr {
    animation: fadeIn 0.2s ease forwards;
    opacity: 0;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(5px); }
    to { opacity: 1; transform: translateY(0); }
  }
  {% for i in range(transactions|length) %}
  tbody tr:nth-child({{ i + 1 }}) { animation-delay: {{ 0.05 * i }}s; }
  {% endfor %}
</style>

<!-- Chart.js -->
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const ctx = document.getElementById('transactionsChart').getContext('2d');
    const data = {{ chart_data | tojson }};

    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: data.labels,
        datasets: [{
          label: 'Сумма (₽)',
          data: data.data,
          backgroundColor: data.colors,  // Цвета из Python
          borderWidth: 2,
          borderColor: '#ffffff',
          hoverOffset: 10  // анимация при наведении
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              usePointStyle: true,  // круглые маркеры
              font: { size: 12 }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed.toFixed(2);
                return ` ${label}: ${value} ₽`;
              }
            }
          }
        },
        // Убираем оси — они не нужны для pie
        scales: undefined
      }
    });
  });
</script>

{% endblock %}
